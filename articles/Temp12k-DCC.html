<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Temp12k-DCC • compositeR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Temp12k-DCC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">compositeR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Temp12k_IceCore.html">Temp12k_IceCore</a>
    </li>
    <li>
      <a href="../articles/Temp12k-DCC.html">Temp12k-DCC</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Temp12k-DCC</h1>
            
      

      <div class="hidden name"><code>Temp12k-DCC.Rmd</code></div>

    </div>

    
    
<p><code>#{r setup} library(compositeR)#devtools::install_github("nickmckay/compositeR") library(geoChronR) #devtools::install_github("nickmckay/geoChronR") library(lipdR)     #devtools::install_github("nickmckay/lipd-utilities",subdir = "R") library(purrr) library(magrittr) library(ggplot2) library(foreach) library(doParallel)</code></p>
<p>```#{r, message=FALSE, warning=FALSE, fig.width=6.5} #Data to use
Temp12k &lt;- Temp12k sg &lt;- pullTsVariable(Temp12k,
“climateInterpretation1_seasonalityGeneral”) ic &lt;-
pullTsVariable(Temp12k, “paleoData_inCompilation”) u &lt;-
pullTsVariable(Temp12k, “paleoData_units”) #TODO this filter isn’t quite
right. Why aren’t seasons standardized (length of fTS should be 782 not
827) tu &lt;- which(tolower(ic) == “temp12k” &amp; (tolower(sg) !=
“summer+” &amp; tolower(sg) != “winter+”) &amp; tolower(u) == “degc”)
fTS &lt;- Temp12k[tu] if(length(fTS)!=782){print(paste0(‘WARNING:
unexpected number (’,length(fTS),‘) of proxy records filtered. The
expected number should be 782 for DCC’))} fTS &lt;-
fTS[!is.na(lapply(pullTsVariable(fTS,‘age’),mean,na.rm=T))] for (i in
1:length(fTS)){ unc &lt;-
as.numeric(fTS[[i]]<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi>o</mi><mi>D</mi><mi>a</mi><mi>t</mi><msub><mi>a</mi><mi>t</mi></msub><mi>e</mi><mi>m</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>e</mi><mn>12</mn><mi>k</mi><mi>U</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>y</mi><mo stretchy="false" form="postfix">)</mo><mi>i</mi><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mi>n</mi><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>u</mi><mi>n</mi><mi>c</mi><mo>&lt;</mo><mo>−</mo><mi>N</mi><mi>A</mi></mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi><mo>&lt;</mo><mo>−</mo><mi>t</mi><mi>o</mi><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi><mo stretchy="false" form="prefix">(</mo><mi>f</mi><mi>T</mi><mi>S</mi><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">[</mo><mi>i</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">paleoData_temperature12kUncertainty)
  if (length(unc)==0){unc&lt;-NA}
  proxy   &lt;- tolower(fTS[[i]]</annotation></semantics></math>paleoData_proxy)
archive &lt;-
tolower(fTS[[i]]<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>c</mi><mi>h</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>T</mi><mi>y</mi><mi>p</mi><mi>e</mi><mo stretchy="false" form="postfix">)</mo><mi>s</mi><mi>e</mi><mi>a</mi><mi>s</mi><mi>o</mi><mi>n</mi><mo>&lt;</mo><mo>−</mo><mi>t</mi><mi>o</mi><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi><mo stretchy="false" form="prefix">(</mo><mi>f</mi><mi>T</mi><mi>S</mi><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">[</mo><mi>i</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">archiveType)
  season  &lt;- tolower(fTS[[i]]</annotation></semantics></math>climateInterpretation1_seasonalityGeneral)
if (is.na(unc)){ if (grepl(‘marine’,archive) &amp; proxy == “alkenone”){
unc &lt;- 1.7 } else if (grepl(‘marine’,archive) &amp; proxy ==
“d18o”){unc &lt;- 2.1 } else if (grepl(‘marine’,archive) &amp; proxy ==
“mg/ca”){ unc &lt;- 1.9 } else if (grepl(‘marine’,archive) &amp; proxy
== “foraminifera”){ if (grepl(‘summer’,season)){ unc &lt;- 1.3 }else if
(grepl(‘winter’,season)){ unc &lt;- 1.4 }else{ unc &lt;- 1.3} } else if
(grepl(‘marine’,archive) &amp; proxy == “dinocyst”){ if
(grepl(‘summer’,season)){ unc &lt;- 1.7 }else if
(grepl(‘winter’,season)){ unc &lt;- 1.2 }else{ unc &lt;- 1.2} } else if
(proxy == ‘tex86’){ unc &lt;- 2.3 } else if (proxy == ‘diatom’){ unc
&lt;- 1.1 } else if (proxy == ‘radiolaria’){ unc &lt;- 1.2 } else if
(proxy == ‘pollen’){ if (grepl(‘summer’,season)){ unc &lt;- 2.0 }else if
(grepl(‘winter’,season)){ unc &lt;- 3.0 }else{ unc &lt;- 2.1} } else if
(proxy == ‘gdgt’){ unc &lt;- 2.9 } else if (proxy == ‘chironomid’){ unc
&lt;- 1.4 } else{ unc &lt;- 2.7 #default }
fTS[[i]]$paleoData_temperature12kUncertainty &lt;- unc } } #bin vectors
for the composite output binvec &lt;- seq(-50, to = 12050, by = 100)
binAges &lt;- rowMeans(cbind(binvec[-1],binvec[-length(binvec)]))</p>
<pre><code>
Text from Kaufman et al. (2020):

"This procedure is similar to the SCC except, instead of using a single time window to align the records, this method applies a dynamic record-aligning procedure and it uses different approaches to characterizing the uncertainties.

The **mean temperatures of each record were adjusted iteratively to optimally minimize the mean offset between each record** and all other records within each latitudinal band over the past 12,000 years. This allowed time series with minimal or no overlap to be included in the composite, so all of the calibrated records in the database were used.

No spatial gridding was applied, but the records were **averaged within latitudinal bands**.

For this method, **errors in the proxy temperatures were either drawn from the posterior outputs of Bayesian temperature calibrations, where available in the database (n = 149, ref. 5), or simulated from the uncertainties summarized for each proxy type**. For the simulation, the uncertainties were assumed to be auto-correlated, with an **AR1 coefficient of 0.71**, such that 50% of the variance in the uncertainties is auto-correlated. This model reflects the contribution of correlated bias, as well as uncorrelated uncertainties. **Age uncertainties were simulated using the Banded Age Model (BAM)27, with a Poisson model and symmetric 5% over- and under-counting probabilities**. Although BAM is designed for layer-counted age modelling, it produces reasonable first-order estimates of age uncertainty, and only requires the original ages as input. To demonstrate this, we compared the BAM-based ensembles produced here to 108 proxy datasets with age models produced by Bacon28. The root mean square error (RMSE) of the ensemble members was calculated relative to the median of each age ensemble over the past 12,000 years. The Bacon models had a median (mean) RMSE of 198 (216) years, whereas the BAM models produced here had a median (mean) RMSE of 251 (260) years. We find that BAM produces age ensembles with uncertainty ranges that are comparable to, but slightly larger than Bacon for these datasets. Although BAM does not accurately represent the full uncertainty structure, it ultimately produces similar, and slightly more conservative, results. Before compositing, DCC randomly selected separate temperature and age ensemble members, thereby effectively propagating these uncertainties through the subsequent compositing steps."

```#{r, message=FALSE, warning=FALSE,  fig.width=6.5}
#Defaults: duration = 3000, searchRange = c(0,7000), gaussianizeInput = FALSE, normalizeVariance = FALSE, 
#          stanFun = standardizeMeanIteratively
#          binFun = sampleEnsembleThenBinTs
fTS_marine &lt;- fTS[pullTsVariable(fTS,'archiveType')=='MarineSediment']
nens &lt;- 3
ensOut &lt;- foreach(i = 1:nens) %dopar% {
  return(ts)
}
groupVar &lt;- 'paleoData_proxyGeneral'
ensOut &lt;- foreach(i = 1:nens) %dopar% {
  out &lt;- vector(mode='list')
  for (group in unique(pullTsVariable(fTS_marine,groupVar))){
    fi &lt;- which(pullTsVariable(fTS_marine,groupVar)==group)
    out[[group]] &lt;-  compositeEnsembles(fTS_marine[fi], binvec, duration = 3000, searchRange = c(0,7000), stanFun = standardizeMeanIteratively, uncVar = 'paleoData_temperature12kUncertainty')
    #out[[group]] &lt;-  compositeDCC(fTS_marine[fi], binvec, uncVar = 'paleoData_temperature12kUncertainty')
  }
  return(out)
  }

</code></pre>
<p>```#{r, message=FALSE, warning=FALSE, fig.width=6.5}
reformatCompositeOut &lt;- function(ensOut,X,groupVar,weights=NA){ if
(is.na(weights)){ w&lt;-rep(1,length(groupVar)) }
else{w&lt;-weights}</p>
<p># reformatComposite &lt;- vector(mode = ‘list’) for (group in
names(ensOut[[1]])){ compMat &lt;- map_dfc(lapply(ensOut,
function(sublist) sublist[[group]]), extract2, ‘composite’) countMat
&lt;- map_dfc(lapply(ensOut, function(sublist) sublist[[group]]),
extract2, ‘timeCount’) countMat[is.na(countMat)] &lt;- 0
reformatComposite[[group]] &lt;-
as.data.frame(cbind(age=X,count=apply(countMat,1,median),compMat)) }
reformatComposite[[‘average’]] &lt;- reformatComposite[[group]]*NA
reformatComposite[[‘average’]]<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>g</mi><mi>e</mi><mo>&lt;</mo><mo>−</mo><mi>a</mi><mi>p</mi><mi>p</mi><mi>l</mi><mi>y</mi><mo stretchy="false" form="prefix">(</mo><mi>s</mi><mi>a</mi><mi>p</mi><mi>p</mi><mi>l</mi><mi>y</mi><mo stretchy="false" form="prefix">(</mo><mi>r</mi><mi>e</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>C</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>o</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo>,</mo><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mi>f</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>f</mi></mrow><annotation encoding="application/x-tex">age   &lt;- apply(sapply(reformatComposite, function(df) df</annotation></semantics></math>age),1,mean,na.rm=T)
reformatComposite[[‘average’]]<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>&lt;</mo><mo>−</mo><mi>a</mi><mi>p</mi><mi>p</mi><mi>l</mi><mi>y</mi><mo stretchy="false" form="prefix">(</mo><mi>s</mi><mi>a</mi><mi>p</mi><mi>p</mi><mi>l</mi><mi>y</mi><mo stretchy="false" form="prefix">(</mo><mi>r</mi><mi>e</mi><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>C</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>o</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo>,</mo><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mi>f</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>f</mi></mrow><annotation encoding="application/x-tex">count &lt;- apply(sapply(reformatComposite, function(df) df</annotation></semantics></math>count),1,sum,na.rm=T)
for (c in colnames(reformatComposite[[‘average’]])[-c(1,2)]){
reformatComposite[[‘average’]][[c]] &lt;-
apply(sapply(reformatComposite, function(df) df[[c]]),1,mean,na.rm=T)
}</p>
<p>return(reformatComposite) }</p>
<p>compDf &lt;- reformatCompositeOut(ensOut,binAges,groupVar)</p>
<pre><code>
``` #{r, message=FALSE, warning=FALSE,  fig.width=6.5}
q = 0
plt &lt;- ggplot() +
  geom_ribbon(aes(x=compDf$average$age,
                  ymin=apply(compDf$average[-c(1,2)],1,quantile,q),
                  ymax=apply(compDf$average[-c(1,2)],1,quantile,1-q)),
              alpha=0.3,color='grey')+
  geom_line(aes(x=compDf$average$age,y=apply(compDf$average[-c(1,2)],1,median)),color='black',size=2)+
  scale_x_reverse(limits=rev(range(binvec)))+
  labs(x='age',y='composite anomaly')+
  theme_bw()
print(plt)
#dim(x_lists)</code></pre>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by McKay Nick, Hancock Christopher.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
